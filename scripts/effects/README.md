# BenchExec Benchmarking

NOTE: If you are interested in generating the Table 1 or Table 2 output,
the simplest option is likely to follow the instructions described 
in `../../Overview.md`. 

Otherwise, in this document we describe our use of BenchExec
 https://github.com/sosy-lab/benchexec/), which is a nearly industral-level
benchmarking tool, that uses Linux CGroups to measure CPU and memory
usage with high precision. We use BenchExec to run Drift and evDrift across
all possible configurations, as well as MoCHi and RCaml.

### 1. Install dependencies

1. Install BenchExec, per the instructions found at:
https://github.com/sosy-lab/benchexec

2. Install Perl modules:

```
cpan -i Statistics::Basic
cpan -i List::Util
cpan -i Math::Complex
```

### 2. Set up BenchExec

* In the following, we assume that environment variable $DRIFT_REPO
is set to the Drift repository root folder. For example:
```
export DRIFT_REPO=~/drift
```

* Symlink drift so it's available in `/usr`:
```
sudo ln -s $DRIFT_REPO/drift.exe /usr/local/bin
```
* Modify the BenchExec toolinfo modules to point to the Drift, MoCHI, and RCaml binaries:
```
nano $DRIFT_REPO/scripts/benchexec-drifttoolinfo/drifttoolinfo/coarmochi.py
nano $DRIFT_REPO/scripts/benchexec-drifttoolinfo/drifttoolinfo/mochi.py
nano $DRIFT_REPO/scripts/benchexec-drifttoolinfo/drifttoolinfo/drift.py
```
* Build the BenchExec toolinfo modules:

```
# May need to be root.
cd $DRIFT_REPO/scripts/benchexec-drifttoolinfo
sudo pip uninstall drifttoolinfo # (if needed)
sudo python3 setup.py sdist bdist_wheel
sudo pip install .
```


### 3. Running benchmarking

#### 3.a Running Drift
```
cd $DRIFT_REPO/scripts/effects
perl makeYamls.pl
perl makeRunDefinitions.pl
benchexec benchmark-drift-autogenerated.xml @benchexec.cfg
```

#### 3.b Running COaR/RCaml

```
cd $DRIFT_REPO/scripts/effects
benchexec benchmark-coarmochi.xml @benchexec.cfg
```

#### 3.c Running MoChi

```
cd $DRIFT_REPO/tests/effects/tr_tuple_mochi
rm *.{json,status,annot,bin} *hors*
chmod 666 *; cd ..; chmod 777 tr_tuple_mochi
cd $DRIFT_REPO/scripts/effects
benchexec benchmark-mochi.xml @benchexec.cfg
```

It will then tell you what `table-generator` command to run.

### 4. Generating LaTeX

Run `table-generator` as instructed by the output of `benchexec`. You will then have two CSV files with names like:

 * `results/benchmark-coarmochi.2024-02-25_10-16-09.results.default.mochibenchmarks.csv`
 * `results/results.2024-02-25_12-18-59.table.csv`

Edit `makeLatex.pl` and provide these as arguments to `parseResultsFile`

Run `perl makeLatex.pl`