# BenchExec Benchmarking

NOTE: If you are interested in generating the Table 1 or Table 2 output,
the simplest option is likely to follow the instructions described 
in `../../README.md`. 

Otherwise, in this document we describe our use of BenchExec
 https://github.com/sosy-lab/benchexec/), which is a nearly industral-level
benchmarking tool, that uses Linux CGroups to measure CPU and memory
usage with high precision. We use BenchExec to run Drift and evDrift across
all possible configurations, as well as MoCHi, Rethfl and RCaml.


### 1. Install dependencies

1. Install BenchExec, per the instructions found at:
https://github.com/sosy-lab/benchexec

2. Install Perl modules:

```
cpan -i Statistics::Basic
cpan -i List::Util
cpan -i Math::Complex
cpan -i DateTime
cpan -i Time::ParseDate
```

### 2. Set up BenchExec

* In the following, we assume that environment variable $DRIFT_REPO
is set to the Drift repository root folder. For example:
```
export DRIFT_REPO=~/drift
```

* If you haven't already, build Drift (after installing dependences per the root README.md)
```
cd $DRIFT_REPO
dune build
```

* Symlink drift so it's available in `/usr`:
```
sudo ln -s $DRIFT_REPO/drift.exe /usr/local/bin
```
* Modify the BenchExec toolinfo modules to point to the Drift, MoCHI, and RCaml binaries:
```
nano $DRIFT_REPO/scripts/benchexec-drifttoolinfo/drifttoolinfo/coarmochi.py
nano $DRIFT_REPO/scripts/benchexec-drifttoolinfo/drifttoolinfo/mochi.py
nano $DRIFT_REPO/scripts/benchexec-drifttoolinfo/drifttoolinfo/drift.py
nano $DRIFT_REPO/scripts/benchexec-drifttoolinfo/drifttoolinfo/driftwrapper.py
nano $DRIFT_REPO/scripts/benchexec-drifttoolinfo/drifttoolinfo/rethfl.py
```
* Build and install the BenchExec toolinfo modules:

```
cd $DRIFT_REPO/scripts/benchexec-drifttoolinfo
make
```

### 3. Running benchmarking

Note that many of these procedures below have Makefile targets. See `./Makefile`

* Benchmarking Drift and evDrift across all possible configuration parameters (makefile target `best_config_csvs`). NOTE: This is very expensive. The following
will generate many possible run definitions and then use BenchExec to
execute drift and evDrift on them:

```
cd $DRIFT_REPO/scripts/effects
perl makeYamls.pl
perl makeRunDefinitions.pl
benchexec benchmark-drift-autogenerated.xml @benchexec.cfg
benchexec benchmark-evdrift-autogenerated.xml @benchexec.cfg
```

Once that completes you must harvest the results as follows. 

* Go into scripts/effects/ and run the TWO `table-generator` commands 
as instructed by BenchExec above. Note: there are two commands to run,
one for Drift, one for evDrift.

* Go into scripts/effects/ and run:

```
perl makeBestConfigs.pl (names of the TWO generated .table.csv file above)
```

* Copy the resulting best_configs_[ev]drift.csvs into the root folder.

* Go into scripts/effects/ and run:

```
perl makeTracePart.pl (names of the TWO generated .table.csv file above)
```

* Copy the resulting tp(on|off)_best_configs_[ev]drift.csvs into the root folder.

* You can now benchmark Drift and evDrift using the best configs (saved to CSVs) generated in the previous step. (You can also now run drift/evDrift by consuming
the best config by running `./drift_benchmark.pl (csv file) test/effects/foo.ml`.)

* With these best_configs_[ev]drift.csv files, we can now benchmark drift/evDrift
along with the other state-of-the-art tools as follows.
(see also `make precise` and `make precise_results`)

```
cd $DRIFT_REPO/scripts/effects
benchexec benchmark-driftwrapper.xml @benchexec.cfg
```

* Benchmarking COaR/RCaml

(see also `make precise` and `make precise_results`)
```
cd $DRIFT_REPO/scripts/effects
benchexec benchmark-coarmochi.xml @benchexec.cfg
```

* Benchmarking MoChi

(see also `make precise` and `make precise_results`)

```
cd $DRIFT_REPO/tests/effects/tr_tuple_mochi
benchexec benchmark-mochi.xml @benchexec.cfg
```

* Benchmarking Rethfl

(see also `make precise` and `make precise_results`)
```
benchexec benchmark-rethfl.xml @benchexec.cfg
```

The Mochi sources are already translated. If you wish to re-run translation use:
```
export MOCHI_EXE="$HOME/MoCHi/src/mochi.exe"
cd $DRIFT_REPO/scripts/effects/
perl ml_rethfl_translate.pl $MOCHI_EXE ../../tests/effects/tr_tuple_mochi/ ../../tests/effects/tr_tuple_hflz
```
### 4. Generating LaTeX results

After each `benchexec` above, you will be given a table-generator instruction to
run, which will produce CSVs for each tool. You will then have CSV files with
names like: `results/benchmark-coarmochi.2024-02-25_10-16-09.results.default.mochibenchmarks.csv`

After generating those CSVs, put these CSV file names into `scripts/effects/csvs.txt`. The final step consumes these CSVs: (See also `make precise_results`.)


```
cd scripts/effects
perl makeLatex.pl csvs.txt
```

This will generate, e.g., exp-body.tex.

